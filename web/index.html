<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ªä¾¡ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f0f0f; color: #eee; font-family: sans-serif; padding: 16px; }
    h1 { font-size: 1.2rem; margin-bottom: 4px; color: #fff; }
    .updated { font-size: 0.75rem; color: #888; margin-bottom: 16px; }
    .card { background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 12px; border-left: 4px solid #444; }
    .card.BUY { border-left-color: #00e676; }
    .card.WAIT { border-left-color: #444; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .name { font-size: 1rem; font-weight: bold; }
    .code { font-size: 0.75rem; color: #888; }
    .signal { font-size: 0.85rem; font-weight: bold; padding: 4px 10px; border-radius: 20px; }
    .signal.BUY { background: #00e676; color: #000; }
    .signal.WAIT { background: #333; color: #aaa; }
    .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .metric { background: #111; border-radius: 8px; padding: 8px 10px; }
    .metric-label { font-size: 0.7rem; color: #888; margin-bottom: 2px; }
    .metric-value { font-size: 1rem; font-weight: bold; }
    .metric-value.green { color: #00e676; }
    .metric-value.red { color: #ff5252; }
    .add-form { background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .add-form h2 { font-size: 0.95rem; margin-bottom: 12px; color: #aaa; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    input { background: #111; border: 1px solid #333; border-radius: 8px; padding: 8px 10px; color: #eee; font-size: 0.9rem; width: 100%; }
    button { background: #00e676; color: #000; border: none; border-radius: 8px; padding: 10px; font-size: 0.9rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 4px; }
    button.secondary { background: #333; color: #aaa; margin-top: 8px; }
    .token-section { background: #1a1a1a; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    .token-section h2 { font-size: 0.95rem; margin-bottom: 12px; color: #aaa; }
    .msg { font-size: 0.8rem; margin-top: 8px; color: #00e676; min-height: 1.2em; }
    .msg.error { color: #ff5252; }
  </style>
</head>
<body>
  <h1>ğŸ“ˆ æ ªä¾¡ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
  <div class="updated" id="updated">èª­ã¿è¾¼ã¿ä¸­...</div>

  <!-- ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®š -->
  <div class="token-section" id="tokenSection">
    <h2>ğŸ”‘ GitHub ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰</h2>
    <input type="password" id="tokenInput" placeholder="ghp_xxxx...">
    <button onclick="saveToken()">ä¿å­˜ã™ã‚‹</button>
    <div class="msg" id="tokenMsg"></div>
  </div>

  <!-- éŠ˜æŸ„è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="add-form">
    <h2>â• éŠ˜æŸ„ã‚’è¿½åŠ </h2>
    <div class="form-row">
      <input type="text" id="newCode" placeholder="è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: 7203ï¼‰">
      <input type="text" id="newName" placeholder="éŠ˜æŸ„åï¼ˆä¾‹: ãƒˆãƒ¨ã‚¿ï¼‰">
    </div>
    <div class="form-row">
      <input type="number" id="newDividend" placeholder="å¹´é–“é…å½“ï¼ˆå††ï¼‰">
      <input type="number" id="newAvgYield" placeholder="å¹³å‡åˆ©å›ã‚Šï¼ˆä¾‹: 3.2ï¼‰" step="0.1">
    </div>
    <button onclick="addStock()">è¿½åŠ ã™ã‚‹</button>
    <div class="msg" id="addMsg"></div>
  </div>

  <div id="cards"></div>

  <script>
    const RESULT_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/result.json";
    const MASTER_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/master.json";
    const REPO = "Asaduki1/stock-monitor";

    // ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†
    function saveToken() {
      const t = document.getElementById("tokenInput").value.trim();
      if (!t) return;
      localStorage.setItem("gh_token", t);
      document.getElementById("tokenMsg").textContent = "âœ… ä¿å­˜ã—ã¾ã—ãŸ";
      document.getElementById("tokenInput").value = "";
      setTimeout(() => {
        document.getElementById("tokenSection").style.display = "none";
      }, 1000);
    }

    function getToken() {
      return localStorage.getItem("gh_token");
    }

    // åˆå›è¡¨ç¤ºï¼šãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°éš ã™
    if (getToken()) {
      document.getElementById("tokenSection").style.display = "none";
    }

    // éŠ˜æŸ„è¿½åŠ 
    async function addStock() {
      const token = getToken();
      if (!token) {
        showMsg("addMsg", "å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„", true);
        document.getElementById("tokenSection").style.display = "block";
        return;
      }

      const code = document.getElementById("newCode").value.trim();
      const name = document.getElementById("newName").value.trim();
      const dividend = parseFloat(document.getElementById("newDividend").value);
      const avgYield = parseFloat(document.getElementById("newAvgYield").value);

      if (!code || !name || isNaN(dividend) || isNaN(avgYield)) {
        showMsg("addMsg", "å…¨é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true);
        return;
      }

      showMsg("addMsg", "è¿½åŠ ä¸­...");

      try {
        // ç¾åœ¨ã®master.jsonã‚’å–å¾—
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          headers: { Authorization: `token ${token}` }
        });
        const fileData = await res.json();
        const current = JSON.parse(atob(fileData.content));

        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (current.find(s => s.code === code)) {
          showMsg("addMsg", "ãã®è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã¯ã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™", true);
          return;
        }

        // æ–°ã—ã„éŠ˜æŸ„ã‚’è¿½åŠ 
        current.push({ code, name, dividend, avg_yield: avgYield });

        // GitHubã«æ›¸ãè¾¼ã¿
        await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `add stock: ${name}(${code})`,
            content: btoa(unescape(encodeURIComponent(JSON.stringify(current, null, 2)))),
            sha: fileData.sha
          })
        });

        showMsg("addMsg", `âœ… ${name}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼æ¬¡å›ã®è‡ªå‹•å®Ÿè¡Œã§åæ˜ ã•ã‚Œã¾ã™`);
        document.getElementById("newCode").value = "";
        document.getElementById("newName").value = "";
        document.getElementById("newDividend").value = "";
        document.getElementById("newAvgYield").value = "";

      } catch (e) {
        showMsg("addMsg", "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„", true);
      }
    }

    function showMsg(id, text, isError = false) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = "msg" + (isError ? " error" : "");
    }

    // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
    function getColorClass(key, value) {
      if (key === "rsi") {
        if (value <= 35) return "green";
        if (value >= 70) return "red";
        return "";
      }
      if (key === "divergence") {
        if (value <= -10) return "green";
        if (value >= 10) return "red";
        return "";
      }
      if (key === "yield") return value >= 4.5 ? "green" : "";
      return "";
    }

    function renderCards(data) {
      const container = document.getElementById("cards");
      container.innerHTML = "";
      data.forEach(s => {
        const card = document.createElement("div");
        card.className = `card ${s.signal}`;
        card.innerHTML = `
          <div class="card-header">
            <div>
              <div class="name">${s.name}</div>
              <div class="code">${s.code}</div>
            </div>
            <div class="signal ${s.signal}">${s.signal}</div>
          </div>
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">æ ªä¾¡</div>
              <div class="metric-value">Â¥${s.price}</div>
            </div>
            <div class="metric">
              <div class="metric-label">é…å½“åˆ©å›ã‚Š</div>
              <div class="metric-value ${getColorClass('yield', s.yield)}">${s.yield}%</div>
            </div>
            <div class="metric">
              <div class="metric-label">RSI</div>
              <div class="metric-value ${getColorClass('rsi', s.rsi)}">${s.rsi}</div>
            </div>
            <div class="metric">
              <div class="metric-label">ä¹–é›¢ç‡</div>
              <div class="metric-value ${getColorClass('divergence', s.divergence)}">${s.divergence}%</div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
      document.getElementById("updated").textContent = `æœ€çµ‚æ›´æ–°: ${data[0]?.updated ?? "ä¸æ˜"}`;
    }

    fetch(RESULT_URL)
      .then(r => r.json())
      .then(renderCards)
      .catch(() => {
        document.getElementById("updated").textContent = "ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—";
      });
  </script>
</body>
</html>
