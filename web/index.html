<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ªä¾¡ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #080c10;
      --surface: #0d1117;
      --border: #1e2a38;
      --accent: #00ffe0;
      --buy: #00ffe0;
      --wait: #3a4a5a;
      --red: #ff4d6d;
      --yellow: #ffd166;
      --text: #c9d6e3;
      --text-dim: #4a6278;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Noto Sans JP', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; padding: 20px 16px; }
    .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
    .header-left h1 { font-family: var(--mono); font-size: 1.1rem; color: var(--accent); letter-spacing: 0.1em; }
    .header-left .subtitle { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; font-family: var(--mono); }
    .updated { font-family: var(--mono); font-size: 0.7rem; color: var(--text-dim); }
    .buy-banner { display: none; background: rgba(0,255,224,0.06); border: 1px solid var(--accent); border-radius: 6px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.8rem; color: var(--accent); font-family: var(--mono); }
    .buy-banner.show { display: block; }
    .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 24px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead tr { background: #0d1117; border-bottom: 1px solid var(--border); }
    th { padding: 10px 14px; text-align: right; font-family: var(--mono); font-size: 0.68rem; color: var(--text-dim); letter-spacing: 0.08em; white-space: nowrap; }
    th:first-child, th:nth-child(2) { text-align: left; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    tbody tr.is-buy { background: rgba(0,255,224,0.04); }
    tbody tr.is-pending { opacity: 0.5; }
    td { padding: 12px 14px; text-align: right; white-space: nowrap; }
    td:first-child { text-align: left; }
    td:nth-child(2) { text-align: left; }
    .code { font-family: var(--mono); font-size: 0.75rem; color: var(--text-dim); }
    .name { font-weight: 700; font-size: 0.85rem; }
    .name.pending { color: var(--text-dim); font-weight: normal; font-style: italic; }
    .price { font-family: var(--mono); font-size: 0.95rem; font-weight: bold; color: #e8f4ff; }
    .signal-badge { display: inline-block; font-family: var(--mono); font-size: 0.68rem; font-weight: bold; padding: 3px 10px; border-radius: 20px; letter-spacing: 0.08em; }
    .signal-badge.BUY { background: rgba(0,255,224,0.15); color: var(--accent); border: 1px solid var(--accent); animation: pulse 2s infinite; }
    .signal-badge.WAIT { background: rgba(255,255,255,0.04); color: var(--text-dim); border: 1px solid var(--border); }
    .signal-badge.PENDING { background: rgba(255,209,102,0.1); color: var(--yellow); border: 1px solid var(--yellow); font-size: 0.62rem; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,255,224,0.3)}50%{box-shadow:0 0 8px 2px rgba(0,255,224,0.15)} }
    .green { color: var(--buy); }
    .red { color: var(--red); }
    .yellow { color: var(--yellow); }
    .add-section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .section-title { font-family: var(--mono); font-size: 0.72rem; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 12px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    input { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-size: 0.82rem; font-family: var(--sans); width: 100%; outline: none; transition: border-color 0.2s; }
    input:focus { border-color: var(--accent); }
    input::placeholder { color: var(--text-dim); }
    .btn { background: rgba(0,255,224,0.1); border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; padding: 9px 16px; font-size: 0.82rem; font-family: var(--mono); cursor: pointer; width: 100%; transition: background 0.2s; letter-spacing: 0.05em; }
    .btn:hover { background: rgba(0,255,224,0.18); }
    .hint { font-size: 0.7rem; color: var(--text-dim); font-family: var(--mono); margin-bottom: 8px; }
    .msg { font-size: 0.75rem; margin-top: 8px; font-family: var(--mono); color: var(--accent); min-height: 1.2em; }
    .msg.error { color: var(--red); }
    .token-section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .token-row { display: flex; gap: 8px; }
    .token-row input { flex: 1; }
    .token-row .btn { width: auto; white-space: nowrap; }
    .loading { text-align: center; padding: 40px; font-family: var(--mono); font-size: 0.8rem; color: var(--text-dim); letter-spacing: 0.1em; }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <h1>â–¸ STOCK MONITOR</h1>
      <div class="subtitle">AUTO UPDATE / 15MIN</div>
    </div>
    <div class="updated" id="updated">--:--</div>
  </div>

  <div class="buy-banner" id="buyBanner"></div>

  <div class="table-wrap">
    <div class="loading" id="loading">LOADING...</div>
    <table id="stockTable" style="display:none">
      <thead>
        <tr>
          <th>CODE</th>
          <th>éŠ˜æŸ„</th>
          <th>æ ªä¾¡</th>
          <th>åˆ©å›ã‚Š</th>
          <th>RSI</th>
          <th>ä¹–é›¢ç‡</th>
          <th>SIGNAL</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="token-section" id="tokenSection">
    <div class="section-title">ğŸ”‘ GitHub Tokenï¼ˆåˆå›ã®ã¿ï¼‰</div>
    <div class="token-row">
      <input type="password" id="tokenInput" placeholder="ghp_xxxx...">
      <button class="btn" onclick="saveToken()">SAVE</button>
    </div>
    <div class="msg" id="tokenMsg"></div>
  </div>

  <div class="add-section">
    <div class="section-title">ï¼‹ éŠ˜æŸ„ã‚’è¿½åŠ </div>
    <div class="input-row">
      <input type="text" id="newCode" placeholder="è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: 8306ï¼‰">
      <button class="btn" style="width:auto;white-space:nowrap;" onclick="addStock()">ADD</button>
    </div>
    <div class="hint">â€» éŠ˜æŸ„åãƒ»é…å½“ãƒ»åˆ©å›ã‚Šã¯æ¬¡å›è‡ªå‹•å®Ÿè¡Œæ™‚ã«å–å¾—ã•ã‚Œã¾ã™</div>
    <div class="msg" id="addMsg"></div>
  </div>

  <script>
    const RESULT_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/result.json";
    const REPO = "Asaduki1/stock-monitor";

    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã—ã¦ã„ã‚‹ä»®è¡¨ç¤ºéŠ˜æŸ„
    const PENDING_KEY = "pending_stocks";

    function getPending() {
      try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); } catch { return []; }
    }
    function savePending(list) {
      localStorage.setItem(PENDING_KEY, JSON.stringify(list));
    }

    function saveToken() {
      const t = document.getElementById("tokenInput").value.trim();
      if (!t) return;
      localStorage.setItem("gh_token", t);
      document.getElementById("tokenMsg").textContent = "âœ“ SAVED";
      document.getElementById("tokenInput").value = "";
      setTimeout(() => { document.getElementById("tokenSection").style.display = "none"; }, 800);
    }
    function getToken() { return localStorage.getItem("gh_token"); }
    if (getToken()) document.getElementById("tokenSection").style.display = "none";

    function colorClass(key, value) {
      if (key === "rsi") return value <= 35 ? "green" : value >= 70 ? "red" : "";
      if (key === "divergence") return value <= -10 ? "green" : value >= 10 ? "red" : "";
      if (key === "yield") return value >= 4.5 ? "green" : "";
      return "";
    }

    function renderTable(data) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("stockTable").style.display = "table";

      // result.jsonã«å«ã¾ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ã‚’è¨˜éŒ²
      const liveCodes = new Set(data.map(s => s.code));

      // å–å¾—æ¸ˆã¿ã«ãªã£ãŸpendingã¯å‰Šé™¤
      let pending = getPending().filter(p => !liveCodes.has(p.code));
      savePending(pending);

      const buys = data.filter(s => s.signal === "BUY");
      if (buys.length > 0) {
        const banner = document.getElementById("buyBanner");
        banner.classList.add("show");
        banner.textContent = "ğŸŸ¢ BUYã‚·ã‚°ãƒŠãƒ«: " + buys.map(s => `${s.name}(${s.code})`).join(" / ");
      }

      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      // é€šå¸¸ãƒ‡ãƒ¼ã‚¿
      data.forEach(s => {
        const tr = document.createElement("tr");
        if (s.signal === "BUY") tr.classList.add("is-buy");
        tr.innerHTML = `
          <td><span class="code">${s.code}</span></td>
          <td><span class="name">${s.name}</span></td>
          <td><span class="price">Â¥${s.price.toLocaleString()}</span></td>
          <td class="${colorClass('yield', s.yield)}">${s.yield}%</td>
          <td class="${colorClass('rsi', s.rsi)}">${s.rsi}</td>
          <td class="${colorClass('divergence', s.divergence)}">${s.divergence}%</td>
          <td><span class="signal-badge ${s.signal}">${s.signal}</span></td>
        `;
        tbody.appendChild(tr);
      });

      // ä»®è¡¨ç¤ºï¼ˆå–å¾—å¾…ã¡ï¼‰
      pending.forEach(p => {
        const tr = document.createElement("tr");
        tr.classList.add("is-pending");
        tr.innerHTML = `
          <td><span class="code">${p.code}</span></td>
          <td><span class="name pending">å–å¾—å¾…ã¡...</span></td>
          <td>--</td>
          <td>--</td>
          <td>--</td>
          <td>--</td>
          <td><span class="signal-badge PENDING">PENDING</span></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("updated").textContent = "UPD " + (data[0]?.updated ?? "--");
    }

    async function addStock() {
      const token = getToken();
      if (!token) {
        showMsg("addMsg", "å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„", true);
        document.getElementById("tokenSection").style.display = "block";
        return;
      }
      const code = document.getElementById("newCode").value.trim();
      if (!code) { showMsg("addMsg", "è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true); return; }

      showMsg("addMsg", "ADDING...");
      try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          headers: { Authorization: `token ${token}` }
        });
        const fileData = await res.json();
        const current = JSON.parse(atob(fileData.content));

        if (current.find(s => s.code === code)) {
          showMsg("addMsg", "ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®ã‚³ãƒ¼ãƒ‰ã§ã™", true); return;
        }

        current.push({ code });

        await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          method: "PUT",
          headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `add: ${code}`,
            content: btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(current, null, 2)))),
            sha: fileData.sha
          })
        });

        // ä»®è¡¨ç¤ºãƒªã‚¹ãƒˆã«è¿½åŠ 
        const pending = getPending();
        if (!pending.find(p => p.code === code)) {
          pending.push({ code });
          savePending(pending);
        }

        showMsg("addMsg", `âœ“ ${code} ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆæ¬¡å›æ›´æ–°ã§åæ˜ ï¼‰`);
        document.getElementById("newCode").value = "";

        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»ã—ã¦ä»®è¡¨ç¤ºã‚’è¿½åŠ 
        const tbody = document.getElementById("tableBody");
        const tr = document.createElement("tr");
        tr.classList.add("is-pending");
        tr.id = `pending-${code}`;
        tr.innerHTML = `
          <td><span class="code">${code}</span></td>
          <td><span class="name pending">å–å¾—å¾…ã¡...</span></td>
          <td>--</td>
          <td>--</td>
          <td>--</td>
          <td>--</td>
          <td><span class="signal-badge PENDING">PENDING</span></td>
        `;
        tbody.appendChild(tr);
        
        document.getElementById("stockTable").style.display = "table";
        document.getElementById("loading").style.display = "none";
        
      } catch(e) {
        showMsg("addMsg", "ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„", true);
      }
    }

    function showMsg(id, text, isError=false) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = "msg" + (isError ? " error" : "");
    }

    let currentData = [];

    function loadData() {
      fetch(RESULT_URL + "?t=" + Date.now())
        .then(r => r.json())
        .then(data => {
          currentData = data;
          renderTable(data);
        })
        .catch(() => {
          document.getElementById("loading").textContent = "DATA LOAD FAILED";
        });
    }

    loadData();
  </script>
</body>
</html>
