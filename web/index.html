<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ê†™‰æ°„É¢„Éã„Çø„Éº</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #080c10;
      --surface: #0d1117;
      --border: #1e2a38;
      --accent: #00ffe0;
      --buy: #00ffe0;
      --wait: #3a4a5a;
      --red: #ff4d6d;
      --yellow: #ffd166;
      --text: #c9d6e3;
      --text-dim: #4a6278;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Noto Sans JP', sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      padding: 20px 16px;
    }

    /* „Éò„ÉÉ„ÉÄ„Éº */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .header-left h1 {
      font-family: var(--mono);
      font-size: 1.1rem;
      color: var(--accent);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .header-left .subtitle {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 2px;
      font-family: var(--mono);
    }

    .updated {
      font-family: var(--mono);
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    /* BUY„Éê„Éä„Éº */
    .buy-banner {
      display: none;
      background: rgba(0, 255, 224, 0.06);
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 10px 14px;
      margin-bottom: 16px;
      font-size: 0.8rem;
      color: var(--accent);
      font-family: var(--mono);
    }
    .buy-banner.show { display: block; }

    /* „ÉÜ„Éº„Éñ„É´ */
    .table-wrap {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
    }

    thead tr {
      background: #0d1117;
      border-bottom: 1px solid var(--border);
    }

    th {
      padding: 10px 14px;
      text-align: right;
      font-family: var(--mono);
      font-size: 0.68rem;
      color: var(--text-dim);
      letter-spacing: 0.08em;
      white-space: nowrap;
    }

    th:first-child, th:nth-child(2) { text-align: left; }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    tbody tr.is-buy { background: rgba(0, 255, 224, 0.04); }

    td {
      padding: 12px 14px;
      text-align: right;
      white-space: nowrap;
    }

    td:first-child { text-align: left; }
    td:nth-child(2) { text-align: left; }

    .code {
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .name {
      font-weight: 700;
      font-size: 0.85rem;
    }

    .price {
      font-family: var(--mono);
      font-size: 0.95rem;
      font-weight: bold;
      color: #e8f4ff;
    }

    .signal-badge {
      display: inline-block;
      font-family: var(--mono);
      font-size: 0.68rem;
      font-weight: bold;
      padding: 3px 10px;
      border-radius: 20px;
      letter-spacing: 0.08em;
    }

    .signal-badge.BUY {
      background: rgba(0, 255, 224, 0.15);
      color: var(--accent);
      border: 1px solid var(--accent);
      animation: pulse 2s infinite;
    }

    .signal-badge.WAIT {
      background: rgba(255,255,255,0.04);
      color: var(--text-dim);
      border: 1px solid var(--border);
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(0,255,224,0.3); }
      50% { box-shadow: 0 0 8px 2px rgba(0,255,224,0.15); }
    }

    .green { color: var(--buy); }
    .red { color: var(--red); }
    .yellow { color: var(--yellow); }

    /* ÈäòÊüÑËøΩÂä†„Éï„Ç©„Éº„É† */
    .add-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .section-title {
      font-family: var(--mono);
      font-size: 0.72rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
    }

    input {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 0.82rem;
      font-family: var(--sans);
      width: 100%;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus { border-color: var(--accent); }
    input::placeholder { color: var(--text-dim); }

    .btn {
      background: rgba(0, 255, 224, 0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
      border-radius: 6px;
      padding: 9px 16px;
      font-size: 0.82rem;
      font-family: var(--mono);
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
      letter-spacing: 0.05em;
    }

    .btn:hover { background: rgba(0, 255, 224, 0.18); }

    .msg {
      font-size: 0.75rem;
      margin-top: 8px;
      font-family: var(--mono);
      color: var(--accent);
      min-height: 1.2em;
    }

    .msg.error { color: var(--red); }

    /* „Éà„Éº„ÇØ„É≥Ë®≠ÂÆö */
    .token-section {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .token-row {
      display: flex;
      gap: 8px;
    }

    .token-row input { flex: 1; }
    .token-row .btn { width: auto; white-space: nowrap; }

    /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
    .loading {
      text-align: center;
      padding: 40px;
      font-family: var(--mono);
      font-size: 0.8rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
    }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <h1>‚ñ∏ STOCK MONITOR</h1>
      <div class="subtitle">AUTO UPDATE / 15MIN</div>
    </div>
    <div class="updated" id="updated">--:--</div>
  </div>

  <!-- BUY„Éê„Éä„Éº -->
  <div class="buy-banner" id="buyBanner"></div>

  <!-- „ÉÜ„Éº„Éñ„É´ -->
  <div class="table-wrap">
    <div class="loading" id="loading">LOADING...</div>
    <table id="stockTable" style="display:none">
      <thead>
        <tr>
          <th>CODE</th>
          <th>ÈäòÊüÑ</th>
          <th>Ê†™‰æ°</th>
          <th>Âà©Âõû„Çä</th>
          <th>RSI</th>
          <th>‰πñÈõ¢Áéá</th>
          <th>SIGNAL</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- „Éà„Éº„ÇØ„É≥Ë®≠ÂÆö -->
  <div class="token-section" id="tokenSection">
    <div class="section-title">üîë GitHub TokenÔºàÂàùÂõû„ÅÆ„ÅøÔºâ</div>
    <div class="token-row">
      <input type="password" id="tokenInput" placeholder="ghp_xxxx...">
      <button class="btn" onclick="saveToken()">SAVE</button>
    </div>
    <div class="msg" id="tokenMsg"></div>
  </div>

  <!-- ÈäòÊüÑËøΩÂä† -->
  <div class="add-section">
    <div class="section-title">Ôºã ÈäòÊüÑ„ÇíËøΩÂä†</div>
    <div class="form-grid">
      <input type="text" id="newCode" placeholder="Ë®ºÂà∏„Ç≥„Éº„ÉâÔºà‰æã: 8306Ôºâ">
      <input type="text" id="newName" placeholder="ÈäòÊüÑÂêçÔºà‰æã: ‰∏âËè±UFJÔºâ">
      <input type="number" id="newDividend" placeholder="Âπ¥ÈñìÈÖçÂΩìÔºàÂÜÜÔºâ">
      <input type="number" id="newAvgYield" placeholder="Âπ≥ÂùáÂà©Âõû„ÇäÔºà‰æã: 3.5Ôºâ" step="0.1">
    </div>
    <button class="btn" onclick="addStock()">ADD STOCK</button>
    <div class="msg" id="addMsg"></div>
  </div>

  <script>
    const RESULT_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/result.json";
    const REPO = "Asaduki1/stock-monitor";

    function saveToken() {
      const t = document.getElementById("tokenInput").value.trim();
      if (!t) return;
      localStorage.setItem("gh_token", t);
      document.getElementById("tokenMsg").textContent = "‚úì SAVED";
      document.getElementById("tokenInput").value = "";
      setTimeout(() => { document.getElementById("tokenSection").style.display = "none"; }, 800);
    }

    function getToken() { return localStorage.getItem("gh_token"); }
    if (getToken()) document.getElementById("tokenSection").style.display = "none";

    function colorClass(key, value) {
      if (key === "rsi") return value <= 35 ? "green" : value >= 70 ? "red" : "";
      if (key === "divergence") return value <= -10 ? "green" : value >= 10 ? "red" : "";
      if (key === "yield") return value >= 4.5 ? "green" : "";
      return "";
    }

    function renderTable(data) {
      document.getElementById("loading").style.display = "none";
      document.getElementById("stockTable").style.display = "table";

      const buys = data.filter(s => s.signal === "BUY");
      if (buys.length > 0) {
        const banner = document.getElementById("buyBanner");
        banner.classList.add("show");
        banner.textContent = "üü¢ BUY„Ç∑„Ç∞„Éä„É´: " + buys.map(s => `${s.name}(${s.code})`).join(" / ");
      }

      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      data.forEach(s => {
        const tr = document.createElement("tr");
        if (s.signal === "BUY") tr.classList.add("is-buy");
        tr.innerHTML = `
          <td><span class="code">${s.code}</span></td>
          <td><span class="name">${s.name}</span></td>
          <td><span class="price">¬•${s.price.toLocaleString()}</span></td>
          <td class="${colorClass('yield', s.yield)}">${s.yield}%</td>
          <td class="${colorClass('rsi', s.rsi)}">${s.rsi}</td>
          <td class="${colorClass('divergence', s.divergence)}">${s.divergence}%</td>
          <td><span class="signal-badge ${s.signal}">${s.signal}</span></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById("updated").textContent = "UPD " + (data[0]?.updated ?? "--");
    }

    async function addStock() {
      const token = getToken();
      if (!token) {
        showMsg("addMsg", "ÂÖà„Å´„Éà„Éº„ÇØ„É≥„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ", true);
        document.getElementById("tokenSection").style.display = "block";
        return;
      }
      const code = document.getElementById("newCode").value.trim();
      const name = document.getElementById("newName").value.trim();
      const dividend = parseFloat(document.getElementById("newDividend").value);
      const avgYield = parseFloat(document.getElementById("newAvgYield").value);
      if (!code || !name || isNaN(dividend) || isNaN(avgYield)) {
        showMsg("addMsg", "ÂÖ®È†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ", true); return;
      }
      showMsg("addMsg", "ADDING...");
      try {
        const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          headers: { Authorization: `token ${token}` }
        });
        const fileData = await res.json();
        const current = JSON.parse(atob(fileData.content));
        if (current.find(s => s.code === code)) {
          showMsg("addMsg", "„Åô„Åß„Å´ÁôªÈå≤Ê∏à„Åø„ÅÆ„Ç≥„Éº„Éâ„Åß„Åô", true); return;
        }
        current.push({ code, name, dividend, avg_yield: avgYield });
        await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
          method: "PUT",
          headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
          body: JSON.stringify({
            message: `add: ${name}(${code})`,
            content: btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(current, null, 2)))),
            sha: fileData.sha
          })
        });
        showMsg("addMsg", `‚úì ${name} „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü`);
        ["newCode","newName","newDividend","newAvgYield"].forEach(id => document.getElementById(id).value = "");
      } catch(e) {
        showMsg("addMsg", "„Ç®„É©„Éº: „Éà„Éº„ÇØ„É≥„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ", true);
      }
    }

    function showMsg(id, text, isError=false) {
      const el = document.getElementById(id);
      el.textContent = text;
      el.className = "msg" + (isError ? " error" : "");
    }

    fetch(RESULT_URL + "?t=" + Date.now())
      .then(r => r.json())
      .then(renderTable)
      .catch(() => {
        document.getElementById("loading").textContent = "DATA LOAD FAILED";
      });
  </script>
</body>
