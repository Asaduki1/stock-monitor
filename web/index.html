<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ ªä¾¡ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <style>
    :root {
      --bg: #080c10;
      --surface: #0d1117;
      --border: #1e2a38;
      --accent: #00ffe0;
      --red: #ff4d6d;
      --yellow: #ffd166;
      --text: #e8f4ff;
      --text-dim: #7a9ab8;
      --mono: 'Share Tech Mono', monospace;
      --sans: 'Noto Sans JP', sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; padding: 20px 16px; }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 12px; }
    .header-left h1 { font-family: var(--mono); font-size: 1.1rem; color: var(--accent); letter-spacing: 0.1em; }
    .header-left .subtitle { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; font-family: var(--mono); }
    .updated { font-family: var(--mono); font-size: 0.7rem; color: var(--text-dim); }

    /* ã‚¿ãƒ– */
    .tabs { display: flex; gap: 4px; margin-bottom: 20px; }
    .tab { font-family: var(--mono); font-size: 0.78rem; padding: 8px 18px; border-radius: 6px; border: 1px solid var(--border); color: var(--text-dim); cursor: pointer; background: none; letter-spacing: 0.05em; transition: all 0.15s; }
    .tab.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,224,0.06); }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«å…±é€š */
    .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead tr { background: #0d1117; border-bottom: 1px solid var(--border); }
    th { padding: 10px 14px; text-align: right; font-family: var(--mono); font-size: 0.68rem; color: #a0c4d8; letter-spacing: 0.06em; white-space: nowrap; }
    th:first-child, th:nth-child(2), th:nth-child(3) { text-align: left; }
    tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    tbody tr.is-buy { background: rgba(0,255,224,0.04); }
    tbody tr.is-pending { opacity: 0.5; }
    td { padding: 11px 14px; text-align: right; white-space: nowrap; }
    td:first-child, td:nth-child(2), td:nth-child(3) { text-align: left; }
    .code { font-family: var(--mono); font-size: 0.75rem; color: var(--text-dim); }
    .name { font-weight: 700; font-size: 0.85rem; }
    .name.pending { color: var(--text-dim); font-weight: normal; font-style: italic; }
    .price { font-family: var(--mono); font-size: 0.95rem; font-weight: bold; color: #e8f4ff; }
    .signal-badge { display: inline-block; font-family: var(--mono); font-size: 0.68rem; font-weight: bold; padding: 3px 10px; border-radius: 20px; letter-spacing: 0.08em; }
    .signal-badge.BUY { background: rgba(0,255,224,0.15); color: var(--accent); border: 1px solid var(--accent); animation: pulse 2s infinite; }
    .signal-badge.WATCH { background: rgba(255,209,102,0.1); color: var(--yellow); border: 1px solid var(--yellow); }
    .signal-badge.WAIT { background: rgba(255,255,255,0.04); color: var(--text-dim); border: 1px solid var(--border); }
    .signal-badge.PENDING { background: rgba(255,209,102,0.1); color: var(--yellow); border: 1px solid var(--yellow); font-size: 0.62rem; }
    @keyframes pulse { 0%,100%{box-shadow:0 0 0 0 rgba(0,255,224,0.3)}50%{box-shadow:0 0 8px 2px rgba(0,255,224,0.15)} }
    .green { color: var(--accent); }
    .red { color: var(--red); }
    .yellow { color: var(--yellow); }

    /* ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ•ã‚©ãƒ¼ãƒ  */
    .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .section-title { font-family: var(--mono); font-size: 0.72rem; color: var(--text-dim); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 12px; }
    .input-row { display: flex; gap: 8px; margin-bottom: 8px; }
    input[type=text], input[type=password], input[type=number] { background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text); font-size: 0.82rem; font-family: var(--sans); width: 100%; outline: none; transition: border-color 0.2s; }
    input:focus { border-color: var(--accent); }
    input::placeholder { color: var(--text-dim); }
    .btn { background: rgba(0,255,224,0.1); border: 1px solid var(--accent); color: var(--accent); border-radius: 6px; padding: 9px 16px; font-size: 0.82rem; font-family: var(--mono); cursor: pointer; transition: background 0.2s; letter-spacing: 0.05em; }
    .btn:hover { background: rgba(0,255,224,0.18); }
    .btn.full { width: 100%; }
    .btn.secondary { border-color: var(--border); color: var(--text-dim); background: none; }
    .btn.yellow { border-color: var(--yellow); color: var(--yellow); background: rgba(255,209,102,0.08); }
    .btn.yellow:hover { background: rgba(255,209,102,0.16); }
    .hint { font-size: 0.7rem; color: var(--text-dim); font-family: var(--mono); margin-bottom: 8px; }
    .msg { font-size: 0.75rem; margin-top: 8px; font-family: var(--mono); color: var(--accent); min-height: 1.2em; }
    .msg.error { color: var(--red); }
    .token-row { display: flex; gap: 8px; }
    .token-row input { flex: 1; }
    .token-row .btn { width: auto; white-space: nowrap; }
    .loading { text-align: center; padding: 40px; font-family: var(--mono); font-size: 0.8rem; color: var(--text-dim); letter-spacing: 0.1em; }
    .buy-banner { display: none; background: rgba(0,255,224,0.06); border: 1px solid var(--accent); border-radius: 6px; padding: 10px 14px; margin-bottom: 16px; font-size: 0.8rem; color: var(--accent); font-family: var(--mono); }
    .buy-banner.show { display: block; }

    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¡ä»¶ */
    .conditions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 14px; }
    .condition-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: border-color 0.15s; }
    .condition-item:hover { border-color: var(--accent); }
    .condition-item input[type=checkbox] { width: 14px; height: 14px; accent-color: var(--accent); flex-shrink: 0; }
    .condition-item label { font-size: 0.75rem; color: var(--text); cursor: pointer; line-height: 1.3; }
    .condition-item.required { border-color: rgba(0,255,224,0.3); }
    .condition-item.required label { color: var(--accent); }
    .required-badge { font-size: 0.6rem; color: var(--accent); font-family: var(--mono); margin-left: 4px; }

    /* ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°çµæœãƒ†ãƒ¼ãƒ–ãƒ« */
    .score-bar { display: flex; gap: 2px; }
    .score-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
    .score-dot.filled { background: var(--accent); }
    .score-dot.filled.yellow { background: var(--yellow); }
    .watch-checkbox { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
    .result-count { font-family: var(--mono); font-size: 0.75rem; color: var(--text-dim); margin-bottom: 10px; }

    /* ãƒšãƒ¼ã‚¸ */
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-left">
    <h1>â–¸ STOCK MONITOR</h1>
    <div class="subtitle">AUTO UPDATE / 15MIN</div>
  </div>
  <div class="updated" id="updated">--:--</div>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('watch')">ç›£è¦–ãƒªã‚¹ãƒˆ</button>
  <button class="tab" onclick="switchTab('screening')">ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°</button>
</div>

<!-- ===== ç›£è¦–ãƒªã‚¹ãƒˆã‚¿ãƒ– ===== -->
<div class="page active" id="page-watch">

  <div class="buy-banner" id="buyBanner"></div>

  <div class="table-wrap">
    <div class="loading" id="loading">LOADING...</div>
    <table id="stockTable" style="display:none">
        <thead>
          <tr>
            <th>CODE</th>
            <th>éŠ˜æŸ„</th>
            <th>æ ªä¾¡</th>
            <th>åˆ©å›ã‚Š</th>
            <th>RSI</th>
            <th>ä¹–é›¢ç‡</th>
            <th>SIGNAL</th>
            <th>å‰Šé™¤</th>
          </tr>
        </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <div class="card" id="tokenSection">
    <div class="section-title">ğŸ”‘ GitHub Tokenï¼ˆåˆå›ã®ã¿ï¼‰</div>
    <div class="token-row">
      <input type="password" id="tokenInput" placeholder="ghp_xxxx...">
      <button class="btn" onclick="saveToken()">SAVE</button>
    </div>
    <div class="msg" id="tokenMsg"></div>
  </div>

  <div class="card">
    <div class="section-title">ï¼‹ éŠ˜æŸ„ã‚’è¿½åŠ </div>
    <div class="input-row">
      <input type="text" id="newCode" placeholder="è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ï¼ˆä¾‹: 8306ï¼‰">
      <button class="btn" style="width:auto;white-space:nowrap;" onclick="addStock()">ADD</button>
    </div>
    <div class="hint">â€» éŠ˜æŸ„åãƒ»é…å½“ãƒ»åˆ©å›ã‚Šã¯æ¬¡å›è‡ªå‹•å®Ÿè¡Œæ™‚ã«å–å¾—ã•ã‚Œã¾ã™</div>
    <div class="msg" id="addMsg"></div>
  </div>

  <div class="card">
    <div class="section-title">ğŸ“¨ Telegram ãƒ†ã‚¹ãƒˆé€ä¿¡</div>
    <div class="input-row" style="margin-bottom:8px;">
      <input type="password" id="tgToken" placeholder="Telegram Bot Token">
    </div>
    <input type="text" id="tgChatId" placeholder="Chat IDï¼ˆä¾‹: 1235454170ï¼‰" style="margin-bottom:8px;">
    <button class="btn full" onclick="sendTestTelegram()">SEND TEST</button>
    <div class="msg" id="tgMsg"></div>
  </div>

</div>

<!-- ===== ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‚¿ãƒ– ===== -->
<div class="page" id="page-screening">

  <div class="card">
    <div class="section-title">ğŸ” ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°æ¡ä»¶</div>

    <div class="conditions-grid">
      <div class="condition-item required">
        <input type="checkbox" id="cond_yield" checked disabled>
        <label for="cond_yield">åˆ©å›ã‚Š 3%ä»¥ä¸Š<span class="required-badge">å¿…é ˆ</span></label>
      </div>
      <div class="condition-item required">
        <input type="checkbox" id="cond_payout" checked disabled>
        <label for="cond_payout">é…å½“æ€§å‘ 30%ä»¥ä¸‹<span class="required-badge">å¿…é ˆ</span></label>
      </div>
      <div class="condition-item required">
        <input type="checkbox" id="cond_pbr" checked disabled>
        <label for="cond_pbr">PBR 1å€å‰²ã‚Œ<span class="required-badge">å¿…é ˆ</span></label>
      </div>
      <div class="condition-item">
        <input type="checkbox" id="cond_ma75" checked>
        <label for="cond_ma75">75æ—¥MAæ¥è¿‘</label>
      </div>
      <div class="condition-item">
        <input type="checkbox" id="cond_ma200" checked>
        <label for="cond_ma200">200æ—¥MAæ¥è¿‘</label>
      </div>
    </div>

    <button class="btn full" onclick="runScreening()">â–¶ æŠ½å‡ºã™ã‚‹</button>
    <div class="msg" id="screeningMsg"></div>
  </div>

  <div id="screeningResultWrap" style="display:none">
    <div class="result-count" id="resultCount"></div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="text-align:left;">ç›£è¦–</th>
            <th style="text-align:left;">CODE</th>
            <th style="text-align:left;">éŠ˜æŸ„</th>
            <th>æ ªä¾¡</th>
            <th>åˆ©å›ã‚Š</th>
            <th>æ€§å‘</th>
            <th>PBR</th>
            <th>ã‚¹ã‚³ã‚¢</th>
            <th>SIGNAL</th>
          </tr>
        </thead>
        <tbody id="screeningBody"></tbody>
      </table>
    </div>
    <button class="btn yellow full" onclick="registerWatched()" style="margin-top:4px;">âœ“ ãƒã‚§ãƒƒã‚¯ã—ãŸéŠ˜æŸ„ã‚’ç›£è¦–ç™»éŒ²</button>
    <div class="msg" id="registerMsg"></div>
  </div>

</div>

<script>
  const RESULT_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/result.json";
  const SCREENING_URL = "https://raw.githubusercontent.com/Asaduki1/stock-monitor/main/data/screening.json";
  const REPO = "Asaduki1/stock-monitor";
  const PENDING_KEY = "pending_stocks";

  // ===== ã‚¿ãƒ–åˆ‡æ›¿ =====
  function switchTab(tab) {
    document.querySelectorAll('.tab').forEach((t, i) => {
      t.classList.toggle('active', ['watch','screening'][i] === tab);
    });
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${tab}`).classList.add('active');
  }

  // ===== ãƒˆãƒ¼ã‚¯ãƒ³ =====
  function saveToken() {
    const t = document.getElementById("tokenInput").value.trim();
    if (!t) return;
    localStorage.setItem("gh_token", t);
    document.getElementById("tokenMsg").textContent = "âœ“ SAVED";
    document.getElementById("tokenInput").value = "";
    setTimeout(() => { document.getElementById("tokenSection").style.display = "none"; }, 800);
  }
  function getToken() { return localStorage.getItem("gh_token"); }
  if (getToken()) document.getElementById("tokenSection").style.display = "none";

  // ===== Pending =====
  function getPending() { try { return JSON.parse(localStorage.getItem(PENDING_KEY) || "[]"); } catch { return []; } }
  function savePending(list) { localStorage.setItem(PENDING_KEY, JSON.stringify(list)); }

  // ===== è‰²ã‚¯ãƒ©ã‚¹ =====
  function colorClass(key, value) {
    if (key === "rsi") return value <= 35 ? "green" : value >= 70 ? "red" : "";
    if (key === "divergence") return value <= -10 ? "green" : value >= 10 ? "red" : "";
    if (key === "yield") return value >= 4.5 ? "green" : "";
    return "";
  }

  // ===== ç›£è¦–ãƒªã‚¹ãƒˆæç”» =====
  function renderTable(data) {
    document.getElementById("loading").style.display = "none";
    document.getElementById("stockTable").style.display = "table";
    const liveCodes = new Set(data.map(s => s.code));
    let pending = getPending().filter(p => !liveCodes.has(p.code));
    savePending(pending);
    const buys = data.filter(s => s.signal === "BUY");
    if (buys.length > 0) {
      const banner = document.getElementById("buyBanner");
      banner.classList.add("show");
      banner.textContent = "ğŸŸ¢ BUYã‚·ã‚°ãƒŠãƒ«: " + buys.map(s => `${s.name}(${s.code})`).join(" / ");
    }
    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";
    data.forEach(s => {
      const tr = document.createElement("tr");
      if (s.signal === "BUY") tr.classList.add("is-buy");
    tr.innerHTML = `
        <td><span class="code">${s.code}</span></td>
        <td><span class="name">${s.name}</span></td>
        <td><span class="price">Â¥${s.price.toLocaleString()}</span></td>
        <td class="${colorClass('yield', s.yield)}">${s.yield}%</td>
        <td class="${colorClass('rsi', s.rsi)}">${s.rsi}</td>
        <td class="${colorClass('divergence', s.divergence)}">${s.divergence}%</td>
        <td><span class="signal-badge ${s.signal}">${s.signal}</span></td>
        <td><button class="btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="deleteStock('${s.code}')">âœ•</button></td>`;
      tbody.appendChild(tr);
    });
    pending.forEach(p => {
      const tr = document.createElement("tr");
      tr.classList.add("is-pending");
      tr.innerHTML = `
        <td><span class="code">${p.code}</span></td>
        <td><span class="name pending">å–å¾—å¾…ã¡...</span></td>
        <td>--</td><td>--</td><td>--</td><td>--</td>
        <td><span class="signal-badge PENDING">PENDING</span></td>
        <td><button class="btn secondary" style="padding:4px 10px;font-size:0.7rem;" onclick="deletePending('${p.code}')">âœ•</button></td>`;
      tbody.appendChild(tr);
    });
    document.getElementById("updated").textContent = "UPD " + (data[0]?.updated ?? "--");
  }

  // ===== éŠ˜æŸ„è¿½åŠ  =====
  async function addStock() {
    const token = getToken();
    if (!token) { showMsg("addMsg", "å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„", true); document.getElementById("tokenSection").style.display = "block"; return; }
    const code = document.getElementById("newCode").value.trim();
    if (!code) { showMsg("addMsg", "è¨¼åˆ¸ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true); return; }
    showMsg("addMsg", "ADDING...");
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, { headers: { Authorization: `token ${token}` } });
      const fileData = await res.json();
      const current = JSON.parse(atob(fileData.content));
      if (current.find(s => s.code === code)) { showMsg("addMsg", "ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã®ã‚³ãƒ¼ãƒ‰ã§ã™", true); return; }
      current.push({ code });
      await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
        method: "PUT",
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: `add: ${code}`, content: btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(current, null, 2)))), sha: fileData.sha })
      });
      const pending = getPending();
      if (!pending.find(p => p.code === code)) { pending.push({ code }); savePending(pending); }
      showMsg("addMsg", `âœ“ ${code} ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
      document.getElementById("newCode").value = "";
      document.getElementById("stockTable").style.display = "table";
      document.getElementById("loading").style.display = "none";
      const tbody = document.getElementById("tableBody");
      const tr = document.createElement("tr");
      tr.classList.add("is-pending");
      tr.id = `pending-${code}`;
      tr.innerHTML = `<td><span class="code">${code}</span></td><td><span class="name pending">å–å¾—å¾…ã¡...</span></td><td>--</td><td>--</td><td>--</td><td>--</td><td><span class="signal-badge PENDING">PENDING</span></td>`;
      tbody.appendChild(tr);
    } catch(e) { showMsg("addMsg", "ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„", true); }
  }

  // ===== ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿè¡Œ =====
  let screeningData = [];

  async function runScreening() {
    showMsg("screeningMsg", "LOADING...");
    document.getElementById("screeningResultWrap").style.display = "none";
    try {
      const res = await fetch(SCREENING_URL + "?t=" + Date.now());
      screeningData = await res.json();

      const useMa75 = document.getElementById("cond_ma75").checked;
      const useMa200 = document.getElementById("cond_ma200").checked;

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆå¿…é ˆ3æ¡ä»¶ã¯å¸¸ã«é©ç”¨ï¼‰
      let filtered = screeningData.filter(s => {
        if (!s.conditions["åˆ©å›ã‚Š3%ä»¥ä¸Š"]) return false;
        if (!s.conditions["é…å½“æ€§å‘30%ä»¥ä¸‹"]) return false;
        if (!s.conditions["PBR1å€å‰²ã‚Œ"]) return false;
        if (useMa75 && !s.conditions["75MAæ¥è¿‘"]) return false;
        if (useMa200 && !s.conditions["200MAæ¥è¿‘"]) return false;
        return true;
      });

      filtered.sort((a, b) => b.score - a.score);
      renderScreening(filtered);
      showMsg("screeningMsg", "");
    } catch(e) {
      showMsg("screeningMsg", "ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—ã€‚screening.jsonãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„", true);
    }
  }

  function renderScreening(data) {
    const tbody = document.getElementById("screeningBody");
    tbody.innerHTML = "";

    data.forEach(s => {
      const tr = document.createElement("tr");
      const isBuy = s.signal === "BUY";
      if (isBuy) tr.classList.add("is-buy");

      const dots = Array.from({length: 5}, (_, i) => {
        const filled = i < s.score;
        const cls = filled ? (isBuy ? "filled" : "filled yellow") : "";
        return `<div class="score-dot ${cls}"></div>`;
      }).join("");

      tr.innerHTML = `
        <td><input type="checkbox" class="watch-checkbox" data-code="${s.code}"></td>
        <td><span class="code">${s.code}</span></td>
        <td><span class="name" style="font-size:0.8rem;">${s.name}</span></td>
        <td><span class="price">Â¥${s.price.toLocaleString()}</span></td>
        <td class="green">${s.yield}%</td>
        <td>${s.payout ?? "--"}%</td>
        <td>${s.pbr ?? "--"}</td>
        <td><div class="score-bar">${dots}</div></td>
        <td><span class="signal-badge ${s.signal}">${s.signal}</span></td>`;
      tbody.appendChild(tr);
    });

    document.getElementById("resultCount").textContent = `${data.length}éŠ˜æŸ„ãŒæ¡ä»¶ã‚’æº€ãŸã—ã¾ã—ãŸ`;
    document.getElementById("screeningResultWrap").style.display = "block";
    document.getElementById("registerMsg").textContent = "";
  }

  // ===== ç›£è¦–ç™»éŒ² =====
  async function registerWatched() {
    const token = getToken();
    if (!token) { showMsg("registerMsg", "å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ï¼ˆç›£è¦–ãƒªã‚¹ãƒˆã‚¿ãƒ–ï¼‰", true); return; }
    const checked = [...document.querySelectorAll(".watch-checkbox:checked")].map(el => el.dataset.code);
    if (checked.length === 0) { showMsg("registerMsg", "éŠ˜æŸ„ã‚’é¸æŠã—ã¦ãã ã•ã„", true); return; }
    showMsg("registerMsg", "ç™»éŒ²ä¸­...");
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, { headers: { Authorization: `token ${token}` } });
      const fileData = await res.json();
      const current = JSON.parse(atob(fileData.content));
      let added = 0;
      checked.forEach(code => {
        if (!current.find(s => s.code === code)) { current.push({ code }); added++; }
      });
      if (added === 0) { showMsg("registerMsg", "é¸æŠã—ãŸéŠ˜æŸ„ã¯ã™ã§ã«ç™»éŒ²æ¸ˆã¿ã§ã™", true); return; }
      await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
        method: "PUT",
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: `add stocks from screening`, content: btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(current, null, 2)))), sha: fileData.sha })
      });
      const pending = getPending();
      checked.forEach(code => { if (!pending.find(p => p.code === code)) pending.push({ code }); });
      savePending(pending);
      showMsg("registerMsg", `âœ“ ${added}éŠ˜æŸ„ã‚’ç›£è¦–ç™»éŒ²ã—ã¾ã—ãŸï¼æ¬¡å›æ›´æ–°ã§åæ˜ ã•ã‚Œã¾ã™`);
    } catch(e) { showMsg("registerMsg", "ã‚¨ãƒ©ãƒ¼: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„", true); }
  }

  // ===== Telegram =====
  async function sendTestTelegram() {
    const token = document.getElementById("tgToken").value.trim();
    const chatId = document.getElementById("tgChatId").value.trim();
    if (!token || !chatId) { showMsg("tgMsg", "Tokenã¨Chat IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", true); return; }
    showMsg("tgMsg", "SENDING...");
    try {
      const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: chatId, text: "ğŸŸ¢ Stock Monitor ãƒ†ã‚¹ãƒˆé€ä¿¡\næ­£å¸¸ã«é€šçŸ¥ãŒå±Šã„ã¦ã„ã¾ã™ï¼" })
      });
      const data = await res.json();
      if (data.ok) { showMsg("tgMsg", "âœ“ é€ä¿¡æˆåŠŸï¼Telegramã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
      else { showMsg("tgMsg", "ã‚¨ãƒ©ãƒ¼: " + data.description, true); }
    } catch(e) { showMsg("tgMsg", "é€ä¿¡å¤±æ•—: ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼", true); }
  }
// ===== éŠ˜æŸ„å‰Šé™¤ =====
  async function deleteStock(code) {
    if (!confirm(`${code} ã‚’ç›£è¦–ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const token = getToken();
    if (!token) { alert("å…ˆã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šã—ã¦ãã ã•ã„"); return; }
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, { headers: { Authorization: `token ${token}` } });
      const fileData = await res.json();
      let current = JSON.parse(atob(fileData.content));
      current = current.filter(s => s.code !== code);
      await fetch(`https://api.github.com/repos/${REPO}/contents/data/master.json`, {
        method: "PUT",
        headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify({ message: `delete: ${code}`, content: btoa(String.fromCharCode(...new TextEncoder().encode(JSON.stringify(current, null, 2)))), sha: fileData.sha })
      });
      document.querySelector(`#tableBody tr.is-buy td span.code, #tableBody td span.code`)?.closest('tr[data-code="${code}"]')?.remove();
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰è©²å½“è¡Œã‚’å‰Šé™¤
      [...document.querySelectorAll('#tableBody td span.code')].find(el => el.textContent === code)?.closest('tr')?.remove();
      showMsg("addMsg", `âœ“ ${code} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    } catch(e) { alert("å‰Šé™¤å¤±æ•—: ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„"); }
  }

  function deletePending(code) {
    if (!confirm(`${code} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    const pending = getPending().filter(p => p.code !== code);
    savePending(pending);
    [...document.querySelectorAll('#tableBody td span.code')].find(el => el.textContent === code)?.closest('tr')?.remove();
    showMsg("addMsg", `âœ“ ${code} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
  }
  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function showMsg(id, text, isError=false) {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = text;
    el.className = "msg" + (isError ? " error" : "");
  }

  // ===== åˆæœŸãƒ­ãƒ¼ãƒ‰ =====
  fetch(RESULT_URL + "?t=" + Date.now())
    .then(r => r.json())
    .then(renderTable)
    .catch(() => { document.getElementById("loading").textContent = "DATA LOAD FAILED"; });
</script>
</body>
</html>
